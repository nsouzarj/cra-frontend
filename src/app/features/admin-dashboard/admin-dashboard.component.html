<div class="dashboard-container">
  <div class="dashboard-header">
    <h1>Dashboard Geral</h1>
  </div>

  <!-- Quick Stats Section -->
  <div class="stats-section" *ngIf="!loading">
    <h2>Resumo das Solicitações</h2>
    <div class="stats-grid">
      <mat-card class="stat-card">
        <mat-card-content>
          <div class="stat-content">
            <div class="stat-icon audiencia">
              <mat-icon>campaign</mat-icon>
            </div>
            <div class="stat-details">
              <h3>Audiências</h3>
              <div class="stat-numbers">
                <span class="primary-number">{{ tipoSolicitacaoCounts.audiencia }}</span>
                <span class="secondary-number">solicitações</span>
              </div>
            </div>
          </div>
        </mat-card-content>
      </mat-card>

      <mat-card class="stat-card">
        <mat-card-content>
          <div class="stat-content">
            <div class="stat-icon diligencia">
              <mat-icon>work</mat-icon>
            </div>
            <div class="stat-details">
              <h3>Diligências</h3>
              <div class="stat-numbers">
                <span class="primary-number">{{ tipoSolicitacaoCounts.diligencia }}</span>
                <span class="secondary-number">solicitações</span>
              </div>
            </div>
          </div>
        </mat-card-content>
      </mat-card>

      <mat-card class="stat-card">
        <mat-card-content>
          <div class="stat-content">
            <div class="stat-icon total">
              <mat-icon>assignment</mat-icon>
            </div>
            <div class="stat-details">
              <h3>Total</h3>
              <div class="stat-numbers">
                <span class="primary-number">{{ stats.totalSolicitacoes }}</span>
                <span class="secondary-number">solicitações</span>
              </div>
            </div>
          </div>
        </mat-card-content>
      </mat-card>
    </div>
  </div>

  <div class="actions-grid" *ngIf="!loading">
    <!-- Users Stats (Admin/Advogado only) -->
    <mat-card class="stat-card" *ngIf="canViewUsers()">
      <mat-card-content>
        <div class="stat-content">
          <div class="stat-icon users">
            <mat-icon>people</mat-icon>
          </div>
          <div class="stat-details">
            <h3>Usuários</h3>
            <div class="stat-numbers">
              <span class="primary-number">{{ stats.totalUsers }}</span>
              <span class="secondary-number">{{ stats.activeUsers }} ativos</span>
            </div>
          </div>
        </div>
      </mat-card-content>
    </mat-card>

    <!-- Correspondentes Stats -->
    <mat-card class="stat-card">
      <mat-card-content>
        <div class="stat-content">
          <div class="stat-icon correspondentes">
            <mat-icon>business</mat-icon>
          </div>
          <div class="stat-details">
            <h3>Correspondentes</h3>
            <div class="stat-numbers">
              <span class="primary-number">{{ stats.totalCorrespondentes }}</span>
              <span class="secondary-number">{{ stats.activeCorrespondentes }} ativos</span>
            </div>
          </div>
        </div>
      </mat-card-content>
    </mat-card>

    <!-- Processos Stats -->
    <mat-card class="stat-card">
      <mat-card-content>
        <div class="stat-content">
          <div class="stat-icon processos">
            <mat-icon>folder</mat-icon>
          </div>
          <div class="stat-details">
            <h3>Processos</h3>
            <div class="stat-numbers">
              <span class="primary-number">{{ stats.totalProcessos }}</span>
              <span class="secondary-number">{{ stats.processosEmAndamento }} em andamento</span>
            </div>
          </div>
        </div>
      </mat-card-content>
    </mat-card>

    <!-- Comarcas Stats -->
    <mat-card class="stat-card" *ngIf="stats.totalComarcas !== undefined">
      <mat-card-content>
        <div class="stat-content">
          <div class="stat-icon comarcas">
            <mat-icon>location_city</mat-icon>
          </div>
          <div class="stat-details">
            <h3>Comarcas</h3>
            <div class="stat-numbers">
              <span class="primary-number">{{ stats.totalComarcas }}</span>
              <span class="secondary-number" *ngIf="stats.comarcasAtivas !== undefined && stats.comarcasInativas !== undefined">
                {{ stats.comarcasAtivas }} ativas, {{ stats.comarcasInativas }} inativas
              </span>
            </div>
          </div>
        </div>
      </mat-card-content>
    </mat-card>
  </div>

  <!-- Charts Section -->
  <div class="charts-section" *ngIf="!loading">
    <h2>Estatísticas Visuais</h2>
    <div class="charts-grid">
      <!-- Entity Type Chart -->
      <mat-card class="chart-card">
        <mat-card-header>
          <mat-card-title>Distribuição de Entidades</mat-card-title>
          <mat-card-subtitle>Quantidade total de cada tipo</mat-card-subtitle>
        </mat-card-header>
        <mat-card-content>
          <div class="chart-container horizontal-scroll-container">
            <div class="bar-chart responsive-bar-chart">
              <div class="chart-bars">
                <div 
                  *ngFor="let value of entityTypeChart.values; let i = index" 
                  class="bar-container"
                  [attr.data-index]="i"
                  [attr.data-value]="value"
                >
                  <div 
                    class="bar" 
                    [ngStyle]="{
                      'height': getBarHeight(value, getMaxValue(entityTypeChart.values)),
                      'background-color': entityTypeChart.colors[i]
                    }"
                    [attr.data-color]="entityTypeChart.colors[i]"
                    [attr.data-height]="getBarHeight(value, getMaxValue(entityTypeChart.values))"
                  ></div>
                  <div class="bar-label">{{ entityTypeChart.labels[i] }}</div>
                  <div class="bar-value">{{ value }}</div>
                </div>
              </div>
            </div>
          </div>
        </mat-card-content>
      </mat-card>

      <!-- Entity Status Chart -->
      <mat-card class="chart-card">
        <mat-card-header>
          <mat-card-title>Status das Entidades</mat-card-title>
          <mat-card-subtitle>Ativos, inativos, em andamento e pendentes</mat-card-subtitle>
        </mat-card-header>
        <mat-card-content>
          <div class="chart-container">
            <div class="pie-chart">
              <div class="pie-chart-container">
                <svg viewBox="0 0 100 100" class="pie-svg">
                  <circle cx="50" cy="50" r="40" fill="none" stroke="#eee" stroke-width="20" />
                  <ng-container *ngFor="let value of entityStatusChart.values; let i = index">
                    <circle 
                      *ngIf="value > 0"
                      cx="50" 
                      cy="50" 
                      r="40" 
                      fill="none" 
                      [attr.stroke]="entityStatusChart.colors[i]"
                      stroke-width="20"
                      [attr.stroke-dasharray]="getPieStrokeDasharray(value, entityStatusChart.values)"
                      [attr.stroke-dashoffset]="getPieStrokeDashoffset(i, entityStatusChart.values)"
                      class="pie-segment"
                    />
                  </ng-container>
                </svg>
                <div class="pie-center">
                  <div class="pie-total">{{ getTotalEntities() }}</div>
                  <div class="pie-label">Total</div>
                </div>
              </div>
              <div class="pie-legend">
                <div 
                  *ngFor="let label of entityStatusChart.labels; let i = index" 
                  class="legend-item"
                >
                  <div 
                    class="legend-color" 
                    [ngStyle]="{'background-color': entityStatusChart.colors[i]}"
                  ></div>
                  <div class="legend-label">{{ label }}: {{ entityStatusChart.values[i] }}</div>
                </div>
              </div>
            </div>
          </div>
        </mat-card-content>
      </mat-card>

      <!-- Solicitações por Status Chart (Bar Chart) -->
      <mat-card class="chart-card">
        <mat-card-header>
          <mat-card-title>Solicitações por Status</mat-card-title>
          <mat-card-subtitle>Distribuição das solicitações por status</mat-card-subtitle>
        </mat-card-header>
        <mat-card-content>
          <div class="chart-container horizontal-scroll-container">
            <div class="bar-chart responsive-bar-chart">
              <div class="chart-bars">
                <div 
                  *ngFor="let value of solicitacoesPorStatusChart.values; let i = index" 
                  class="bar-container"
                >
                  <div 
                    class="bar" 
                    [ngStyle]="{
                      'height': getBarHeight(value, getMaxValue(solicitacoesPorStatusChart.values)),
                      'background-color': solicitacoesPorStatusChart.colors[i]
                    }"
                    [attr.data-color]="solicitacoesPorStatusChart.colors[i]"
                    [attr.data-height]="getBarHeight(value, getMaxValue(solicitacoesPorStatusChart.values))"
                  ></div>
                  <div class="bar-label">{{ solicitacoesPorStatusChart.labels[i] }}</div>
                  <div class="bar-value">{{ value }}</div>
                </div>
              </div>
            </div>
          </div>
        </mat-card-content>
      </mat-card>

      <!-- Solicitações Atrasadas Chart -->
      <mat-card class="chart-card">
        <mat-card-header>
          <mat-card-title>Solicitações Atrasadas por Período</mat-card-title>
          <mat-card-subtitle>Contagem de solicitações com prazo vencido</mat-card-subtitle>
        </mat-card-header>
        <mat-card-content>
          <div class="chart-container horizontal-scroll-container">
            <div class="bar-chart responsive-bar-chart">
              <div class="chart-bars">
                <div
                  *ngFor="let value of solicitacoesAtrasadasChart.values; let i = index"
                  class="bar-container"
                  (click)="navigateToOverdueRequests(solicitacoesAtrasadasChart.labels[i])"
                >
                  <div
                    class="bar"
                    [ngStyle]="{
                      'height': getBarHeight(value, getMaxValue(solicitacoesAtrasadasChart.values)),
                      'background-color': solicitacoesAtrasadasChart.colors[i]
                    }"
                  ></div>
                  <div class="bar-label">{{ solicitacoesAtrasadasChart.labels[i] }}</div>
                  <div class="bar-value">{{ value }}</div>
                </div>
              </div>
            </div>
          </div>
        </mat-card-content>
      </mat-card>

      <!-- Solicitações por Status Chart (Pie Chart) -->
      <mat-card class="chart-card">
        <mat-card-header>
          <mat-card-title>Distribuição de Solicitações</mat-card-title>
          <mat-card-subtitle>Proporção de solicitações por status</mat-card-subtitle>
        </mat-card-header>
        <mat-card-content>
          <div class="chart-container horizontal-scroll-container">
            <div class="pie-chart">
              <div class="pie-chart-container">
                <svg viewBox="0 0 100 100" class="pie-svg">
                  <circle cx="50" cy="50" r="40" fill="none" stroke="#eee" stroke-width="20" />
                  <ng-container *ngFor="let value of solicitacoesPorStatusChart.values; let i = index">
                    <circle 
                      *ngIf="value > 0"
                      cx="50" 
                      cy="50" 
                      r="40" 
                      fill="none" 
                      [attr.stroke]="solicitacoesPorStatusChart.colors[i]"
                      stroke-width="20"
                      [attr.stroke-dasharray]="getPieStrokeDasharray(value, solicitacoesPorStatusChart.values)"
                      [attr.stroke-dashoffset]="getPieStrokeDashoffset(i, solicitacoesPorStatusChart.values)"
                      class="pie-segment"
                    />
                  </ng-container>
                </svg>
                <div class="pie-center">
                  <div class="pie-total">{{ getTotalSolicitacoes() }}</div>
                  <div class="pie-label">Total</div>
                </div>
              </div>
              <div class="pie-legend">
                <div 
                  *ngFor="let label of solicitacoesPorStatusChart.labels; let i = index" 
                  class="legend-item"
                >
                  <div 
                    class="legend-color" 
                    [ngStyle]="{'background-color': solicitacoesPorStatusChart.colors[i]}"
                  ></div>
                  <div class="legend-label">{{ label }}: {{ solicitacoesPorStatusChart.values[i] }}</div>
                </div>
              </div>
            </div>
          </div>
        </mat-card-content>
      </mat-card>

      <!-- Top Comarcas Chart -->
      <mat-card class="chart-card" *ngIf="topComarcas && topComarcas.length > 0">
        <mat-card-header>
          <mat-card-title>Principais Comarcas</mat-card-title>
          <mat-card-subtitle>Comarcas com mais solicitações</mat-card-subtitle>
        </mat-card-header>
        <mat-card-content>
          <div class="chart-container horizontal-scroll-container">
            <div class="bar-chart responsive-bar-chart">
              <div class="chart-bars">
                <div 
                  *ngFor="let comarca of topComarcas; let i = index" 
                  class="bar-container"
                >
                  <div 
                    class="bar" 
                    [ngStyle]="{
                      'height': getComarcaBarHeight(comarca.count),
                      'background-color': getStatusColor(comarca.comarcaNome, i)
                    }"
                  ></div>
                  <div class="bar-label">{{ comarca.comarcaNome }} ({{ comarca.uf }})</div>
                  <div class="bar-value">{{ comarca.count }}</div>
                </div>
              </div>
            </div>
          </div>
        </mat-card-content>
      </mat-card>
    </div>
  </div>

  <!-- Loading State -->
  <div class="loading-container" *ngIf="loading">
    <mat-spinner></mat-spinner>
    <p>Carregando estatísticas...</p>
  </div>

  <!-- Quick Actions -->
  <div class="quick-actions" *ngIf="!loading">
    <h2>Ações Rápidas</h2>
    <div class="actions-grid clickable">
      <mat-card class="action-card" *ngIf="authService.isAdmin()" routerLink="/register">
        <mat-card-content>
          <mat-icon>person_add</mat-icon>
          <h3>Cadastrar Usuário</h3>
          <p>Adicionar um novo usuário ao sistema</p>
        </mat-card-content>
      </mat-card>

      <mat-card class="action-card" routerLink="/correspondentes/novo">
        <mat-card-content>
          <mat-icon>business</mat-icon>
          <h3>Novo Correspondente</h3>
          <p>Cadastrar um novo correspondente</p>
        </mat-card-content>
      </mat-card>

      <mat-card class="action-card" routerLink="/processos/novo">
        <mat-card-content>
          <mat-icon>folder_open</mat-icon>
          <h3>Novo Processo</h3>
          <p>Adicionar um novo processo legal</p>
        </mat-card-content>
      </mat-card>

      <mat-card class="action-card" routerLink="/solicitacoes/novo">
        <mat-card-content>
          <mat-icon>assignment_add</mat-icon>
          <h3>Nova Solicitação</h3>
          <p>Criar uma nova solicitação de serviço</p>
        </mat-card-content>
      </mat-card>
      
      <!-- Correspondent Dashboard Action -->
      <mat-card class="action-card" *ngIf="authService.isCorrespondente()" routerLink="/correspondent-dashboard">
        <mat-card-content>
          <mat-icon>dashboard</mat-icon>
          <h3>Meu Dashboard</h3>
          <p>Visualizar minhas estatísticas</p>
        </mat-card-content>
      </mat-card>
    </div>
  </div>

  <!-- Recent Activity (Future Enhancement) -->
  <div class="recent-activity" *ngIf="!loading">
    <h2>Atividade Recente</h2>
    <mat-card class="centered-card">
      <mat-card-content>
        <p class="coming-soon">Funcionalidade em desenvolvimento...</p>
      </mat-card-content>
    </mat-card>
  </div>
</div>