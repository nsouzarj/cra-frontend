<div class="request-form-container">
  <mat-card class="form-card">
    <mat-card-header>
      <mat-card-title>{{ isEditMode ? 'Editar Solicitação' : 'Nova Solicitação' }}</mat-card-title>
      <mat-card-subtitle>
        {{ isEditMode ? 'Altere os dados da solicitação' : 'Preencha os dados da nova solicitação' }}
        <div *ngIf="isEditMode && requestId" class="solicitacao-id">ID da Solicitação: {{ requestId }}</div>
      </mat-card-subtitle>
    </mat-card-header>
    <mat-card-content>
      <form [formGroup]="requestForm" (ngSubmit)="onSubmit()">
        <!-- Basic Information -->
        <div class="form-section">
          <h3>Informações Básicas</h3>
          
          <div class="form-row">
            <mat-form-field class="form-field" appearance="outline">
              <mat-label>Processo *</mat-label>
              <mat-select formControlName="processo">
                <mat-option *ngFor="let processo of filteredProcessos" [value]="processo.id">
                  {{ processo.numeroprocesso }} - {{ processo.parte }}
                </mat-option>
              </mat-select>
              <mat-error *ngIf="isFieldInvalid('processo')">
                {{ getFieldErrorMessage('processo') }}
              </mat-error>
            </mat-form-field>

            <mat-form-field class="form-field" appearance="outline">
              <mat-label>Correspondente *</mat-label>
              <mat-select formControlName="correspondente">
                <mat-option *ngFor="let correspondente of filteredCorrespondentes" [value]="correspondente.id">
                  {{ correspondente.nome }} - {{ correspondente.oab }}
                </mat-option>
              </mat-select>
              <mat-error *ngIf="isFieldInvalid('correspondente')">
                {{ getFieldErrorMessage('correspondente') }}
              </mat-error>
            </mat-form-field>
          </div>

          <div class="form-row">
            <mat-form-field class="form-field" appearance="outline">
              <mat-label>Tipo de Solicitação *</mat-label>
              <mat-select formControlName="tipoSolicitacao" (selectionChange)="onTipoSolicitacaoChange($event.value)">
                <mat-option *ngFor="let tipo of tiposSolicitacao" [value]="tipo.idtiposolicitacao">
                  {{ tipo.especie }} - {{ tipo.tipo }}
                </mat-option>
              </mat-select>
              <mat-error *ngIf="isFieldInvalid('tipoSolicitacao')">
                {{ getFieldErrorMessage('tipoSolicitacao') }}
              </mat-error>
            </mat-form-field>

            <mat-form-field class="form-field" appearance="outline">
              <mat-label>Usuário *</mat-label>
              <mat-select formControlName="usuario">
                <mat-option *ngFor="let usuario of usuarios" [value]="usuario.id">
                  {{ usuario.nomecompleto }} ({{ usuario.login }})
                </mat-option>
              </mat-select>
              <mat-error *ngIf="isFieldInvalid('usuario')">
                {{ getFieldErrorMessage('usuario') }}
              </mat-error>
            </mat-form-field>
          </div>
        </div>

        <!-- Date Information -->
        <div class="form-section">
          <h3>Datas</h3>
          
          <div class="form-row">
            <mat-form-field class="form-field" appearance="outline">
              <mat-label>Data da Solicitação</mat-label>
              <input matInput [matDatepicker]="solicitacaoPicker" formControlName="dataSolicitacao">
              <mat-datepicker-toggle matSuffix [for]="solicitacaoPicker"></mat-datepicker-toggle>
              <mat-datepicker #solicitacaoPicker></mat-datepicker>
            </mat-form-field>

            <mat-form-field class="form-field" appearance="outline">
              <mat-label>Data do Prazo</mat-label>
              <input matInput [matDatepicker]="prazoPicker" formControlName="dataPrazo">
              <mat-datepicker-toggle matSuffix [for]="prazoPicker"></mat-datepicker-toggle>
              <mat-datepicker #prazoPicker></mat-datepicker>
            </mat-form-field>
          </div>

          <!-- Conditional fields for Audiência only -->
          <div *ngIf="showAudienciaFields">
            <div class="form-row">
              <mat-form-field class="form-field" appearance="outline">
                <mat-label>Data do Agendamento</mat-label>
                <input matInput [matDatepicker]="agendamentoPicker" formControlName="dataAgendamento">
                <mat-datepicker-toggle matSuffix [for]="agendamentoPicker"></mat-datepicker-toggle>
                <mat-datepicker #agendamentoPicker></mat-datepicker>
              </mat-form-field>

              <mat-form-field class="form-field" appearance="outline">
                <mat-label>Hora da Audiência</mat-label>
                <input matInput type="time" formControlName="horaAudiencia">
              </mat-form-field>
            </div>
          </div>
        </div>

        <!-- Value and Status Information -->
        <div class="form-section">
          <h3>Valor e Status</h3>
          
          <div class="form-row">
            <!-- Valor field (shown for Audiência and Diligência) -->
            <mat-form-field class="form-field" appearance="outline" *ngIf="showValorField">
              <mat-label>Valor *</mat-label>
              <span matPrefix>R$&nbsp;</span>
              <input matInput type="text" [value]="formatCurrencyDisplay(requestForm.get('valor')?.value)" (input)="formatCurrency($event)" placeholder="0,00">
              <mat-error *ngIf="isFieldInvalid('valor')">
                {{ getFieldErrorMessage('valor') }}
              </mat-error>
            </mat-form-field>

            <!-- Status field - only shown when editing -->
            <mat-form-field class="form-field" appearance="outline" *ngIf="isEditMode">
              <mat-label>Status da Solicitação</mat-label>
              <mat-select formControlName="status">
                <mat-option *ngFor="let status of statuses" [value]="status.idstatus">
                  {{ status.status }}
                </mat-option>
              </mat-select>
            </mat-form-field>

            <!-- Default status display for new solicitations -->
            <mat-form-field class="form-field" appearance="outline" *ngIf="!isEditMode" readonly>
              <mat-label>Status</mat-label>
              <input matInput value="Aguardando Confirmação" readonly>
            </mat-form-field>
          </div>
        </div>

        <div class="form-section" *ngIf="loadedSolicitacao?.statusSolicitacao?.status === 'Concluído' || loadedSolicitacao?.statusSolicitacao?.status === 'Finalizado'"> 
          <h3>Observações do Correspondente</h3>
            <h4 style="color: black;">{{ loadedSolicitacao?.observacao }} </h4> 
        </div>

        <!-- Instructions -->
        <div class="form-section">
          <h3>Instruções da Solicitação</h3>
          
          <mat-form-field class="form-field full-width" appearance="outline">
            <mat-label>Instruções</mat-label>
            <textarea matInput formControlName="instrucoes" rows="3"></textarea>
          </mat-form-field>
        </div>

        <!-- File Attachments Section -->
        <div class="form-section">
          <h3>Anexos</h3>
          
          <div class="file-upload-section">
            <!-- Storage location selection -->
            <div class="storage-selection">
              <mat-radio-group [(ngModel)]="storageLocation" [ngModelOptions]="{standalone: true}" class="storage-radio-group">
                <mat-radio-button value="local" class="storage-option">
                  <mat-icon>computer</mat-icon>
                  <span>Armazenamento Local</span>
                </mat-radio-button>
                <mat-radio-button value="google_drive" class="storage-option">
                  <mat-icon>cloud_upload</mat-icon>
                  <span>Google Drive</span>
                </mat-radio-button>
              </mat-radio-group>
            </div>
            
            <div class="file-input-container">
              <input type="file" #fileInput (change)="selectFiles($event)" multiple accept=".pdf,.jpg,.jpeg,.png,.doc,.docx" />
              <button mat-raised-button type="button" (click)="fileInput.click()" [disabled]="loading">
                Selecionar Arquivos
              </button>
              <span class="file-info" *ngIf="selectedFiles.length > 0">
                {{ selectedFiles.length }} arquivo(s) selecionado(s)
              </span>
            </div>

            <!-- List of selected files -->
            <div *ngIf="selectedFiles.length > 0" class="selected-files">
              <h4>Arquivos Selecionados:</h4>
              <div *ngFor="let file of selectedFiles; let i = index" class="file-item">
                <mat-icon>description</mat-icon>
                <span>{{ file.name }}</span>
                <button mat-icon-button (click)="removeSelectedFile(i)" matTooltip="Remover arquivo">
                  <mat-icon>delete</mat-icon>
                </button>
              </div>
            </div>

            <!-- Progress bars for uploads -->
            <div *ngIf="progressInfos.length > 0" class="progress-container">
              <div *ngFor="let progressInfo of progressInfos; let i = index" class="progress-item">
                <span>{{ progressInfo.fileName }}</span>
                <mat-progress-bar mode="determinate" [value]="progressInfo.value"></mat-progress-bar>
              </div>
            </div>

            <!-- Message display -->
            <div *ngIf="message" class="message-container">
              {{ message }}
            </div>

            <!-- List of existing attachments (for edit mode) with same styling as detail view -->
            <div *ngIf="currentFiles.length > 0" class="attachments-list">
              <h4>Arquivos Anexados:</h4>
              <div *ngFor="let file of currentFiles" class="attachment-item" [ngClass]="getAttachmentClass(file)">
                <mat-icon>description</mat-icon>
                <div class="attachment-info">
                  <span class="attachment-name">{{ file.nomearquivo }}</span>
                  <span class="attachment-date" *ngIf="file.dataInclusao">
                    Adicionado em: {{ formatDateTime(file.dataInclusao) }}
                  </span>
                  <span class="attachment-origin" *ngIf="file.origem">
                    Origem: {{ file.origem === 'correspondente' ? 'Correspondente' : 'Solicitante' }}
                  </span>
                </div>
                <div class="attachment-actions">
                  <button mat-icon-button 
                          (click)="downloadAnexo(file.id!, file.nomearquivo, file.storageLocation)" 
                          [attr.aria-label]="'Baixar ' + file.nomearquivo"
                          matTooltip="Baixar arquivo"
                          class="download-button">
                    <mat-icon>download</mat-icon>
                  </button>
                  <span class="tooltip-wrapper" 
                        matTooltip="Não é possível excluir arquivos na edição" 
                        matTooltipPosition="above"
                        matTooltipShowDelay="0"
                        matTooltipHideDelay="1000"
                        class="disabled">
                    <button mat-icon-button 
                            [attr.aria-label]="'Excluir ' + file.nomearquivo"
                            class="delete-button"
                            [disabled]="true">
                      <mat-icon>delete</mat-icon>
                    </button>
                  </span>
                </div>
              </div>
            </div>
          </div>
        </div>

        <div class="form-actions">
          <button mat-button type="button" (click)="onCancel()" [disabled]="loading">
            Cancelar
          </button>
          <button mat-raised-button color="primary" type="submit" [disabled]="requestForm.invalid || loading">
            <span *ngIf="!loading">{{ isEditMode ? 'Atualizar' : 'Criar' }}</span>
            <mat-spinner *ngIf="loading" diameter="20"></mat-spinner>
          </button>
        </div>
      </form>
    </mat-card-content>
  </mat-card>
</div>