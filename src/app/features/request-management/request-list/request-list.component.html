<div class="request-list-container">
  <mat-toolbar class="toolbar">
    <h1>Solicitações Elaboradas</h1>
    <span class="spacer"></span>
    <button *ngIf="permissionService.canCreateRequests()" mat-raised-button color="primary" routerLink="/solicitacoes/novo">
      <mat-icon>add</mat-icon>
      Nova Solicitação
    </button>
  </mat-toolbar>

  <!-- Filter Section - Using the new RequestFilterComponent -->
  <mat-card class="filter-card">
    <mat-card-content>
      <app-request-filter 
        [showCorrespondentFilter]="true"
        (filterChange)="onFilterChange($event)"
        (clearFilters)="clearFilters()">
      </app-request-filter>
    </mat-card-content>
  </mat-card>

  <mat-card>
    <mat-card-content>
      <div class="table-container" *ngIf="!loading">
        <div class="table-info">
          Total de solicitações: {{ dataSource.data.length }}
        </div>
        
        <table mat-table [dataSource]="dataSource" matSort>
          <ng-container [style]="{'width': '30px'}" matColumnDef="id">
            <th style="width: 50px;" mat-header-cell *matHeaderCellDef mat-sort-header>ID</th>
            <td mat-cell *matCellDef="let solicitacao">{{ solicitacao.id }}</td>
          </ng-container>

          <ng-container [style]="{'width': '250px'}" matColumnDef="datasolicitacao">
            <th style="width: 180px;" mat-header-cell *matHeaderCellDef mat-sort-header>Data Solicitação</th>
            <td mat-cell *matCellDef="let solicitacao">{{ solicitacao.datasolicitacao | date:'dd/MM/yyyy' }}</td>
          </ng-container>

          <ng-container matColumnDef="dataprazo">
            <th mat-header-cell *matHeaderCellDef mat-sort-header>Prazo</th>
            <td mat-cell 
                *matCellDef="let solicitacao"
                [ngClass]="getPrazoInfo(solicitacao).class"
                [matTooltip]="getPrazoInfo(solicitacao).tooltip">
              {{ solicitacao.dataprazo | date:'dd/MM/yyyy' }}
            </td>
          </ng-container>

          <ng-container matColumnDef="tipoSolicitacao">
            <th mat-header-cell *matHeaderCellDef mat-sort-header>Tipo</th>
            <td mat-cell *matCellDef="let solicitacao">
              {{ solicitacao.tipoSolicitacao?.especie }} - {{ solicitacao.tipoSolicitacao?.tipo }}
            </td>
          </ng-container>

          <ng-container matColumnDef="processo">
            <th mat-header-cell *matHeaderCellDef mat-sort-header>Processo</th>
            <td mat-cell *matCellDef="let solicitacao">
              {{ solicitacao.processo?.numeroprocesso || '-' }}
            </td>
          </ng-container>

          <ng-container matColumnDef="correspondente">
            <th mat-header-cell *matHeaderCellDef mat-sort-header>Correspondente</th>
            <td mat-cell *matCellDef="let solicitacao">
              {{ solicitacao.correspondente?.nome || '-' }}
            </td>
          </ng-container>

          <ng-container matColumnDef="status">
            <th mat-header-cell *matHeaderCellDef mat-sort-header>Status</th>
            <td mat-cell *matCellDef="let solicitacao">
              <mat-chip [ngClass]="getStatusClass(solicitacao.statusSolicitacao?.status)">
                {{ solicitacao.statusSolicitacao?.status || 'Pendente' }}
              </mat-chip>
            </td>
          </ng-container>

          <!-- Actions Column -->
          <ng-container matColumnDef="actions">
            <th mat-header-cell *matHeaderCellDef>Ações</th>
            <td mat-cell *matCellDef="let solicitacao">
              <div class="action-buttons">
                <button mat-icon-button [routerLink]="['/solicitacoes/visualizar', solicitacao.id]" class="view-action" matTooltip="Visualizar Solicitação">
                  <mat-icon>visibility</mat-icon>
                </button>
                
                <!-- Using Permission Service -->
                <button *ngIf="permissionService.canEditRequests()" mat-icon-button [routerLink]="['/solicitacoes/editar', solicitacao.id]" class="edit-action" matTooltip="Editar Solicitação">
                  <mat-icon>edit</mat-icon>
                </button>
                
                <!-- PDF Report button -->
                <button mat-icon-button class="pdf-action" (click)="generatePdfReport(solicitacao.id)" matTooltip="Gerar Relatório PDF" [disabled]="pdfLoading.has(solicitacao.id)">
                  <mat-spinner *ngIf="pdfLoading.has(solicitacao.id)" [diameter]="24"></mat-spinner>
                  <mat-icon *ngIf="!pdfLoading.has(solicitacao.id)">picture_as_pdf</mat-icon>
                </button>
                
                <!-- Delete button only for admins -->
                <button *ngIf="authService.isAdminUser" mat-icon-button (click)="deleteRequest(solicitacao.id)" class="delete-action" matTooltip="Excluir Solicitação">
                  <mat-icon>delete</mat-icon>
                </button>
              </div>
            </td>
          </ng-container>

          <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
          <tr mat-row *matRowDef="let row; columns: displayedColumns;"></tr>
        </table>

        <!-- Pagination -->
        <mat-paginator #paginator 
                       [pageSizeOptions]="pageSizeOptions"
                       [pageSize]="pageSize"
                       [length]="totalElements"
                       [pageIndex]="currentPage"
                       (page)="paginatorPageChanged($event)"
                       showFirstLastButtons
                       aria-label="Selecionar página de solicitações">
        </mat-paginator>
      </div>

      <div class="loading-container" *ngIf="loading">
        <mat-spinner></mat-spinner>
        <p>Carregando solicitações...</p>
      </div>
      
      <div class="no-data" *ngIf="!loading && dataSource.data.length === 0">
        <p>Nenhuma solicitação encontrada.</p>
      </div>
    </mat-card-content>
  </mat-card>
</div>